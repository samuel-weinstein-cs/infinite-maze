<html>
	<canvas id="myCanvas" width="700" height="700" style="border:1px solid #000000;"></canvas>
	<script type="text/javascript">
			window.onerror=function(msg, url, linenumber){
			 alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber)
			 return true
			}
	</script>
	<script src=http://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js></script>
	<script>
Array.prototype.containsArray = function(val) {
    var hash = {};
    for(var i=0; i<this.length; i++) {
        hash[this[i]] = i;
    }
    return hash.hasOwnProperty(val);
}
var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");
function randint(min, max){
 return Math.floor(Math.random() * (max - min + 1)) + min;
}
function floor(x){
	if (x>0){
		return Math.floor(x);
	} else {
		return Math.ceil(x);
	}
}
function dir(d){
	var x=0;
	var y=0;
	if (d==0){
		y=-1;
	}
	if (d==1){
		x=1;
	}
	if (d==2){
		y=1;
	}
	if (d==3){
		x=-1;
	}
	return [x, y];
}
function invd(d){
	if (d==0){
		d=2;
	}
	else if (d==1){
		d=3;
	}
	else if (d==2){
		d=0;
	}
	else if (d==3){
		d=1;
	}
	return d;
}
var s='test';
function generate(maze,x,y,closed){
	//draw(maze);
	var fin=false;
	var d=randint(0,3)
	if((y+dir(d)[1]>=0 && y+dir(d)[1]<=4) && (x+dir(d)[0]>=0 && x+dir(d)[0]<=4)){
		if(maze[y+dir(d)[1]][x+dir(d)[0]]=='0,0,0,0'){
			closed.push([x,y]);
			maze[y][x][d]=1;
			x+=dir(d)[0];
			y+=dir(d)[1];
			maze[y][x][invd(d)]=1;
		}
		var pop = false;
		//alert('got here');
		for (var i=0; i<=3; i++){
			if(!((y+dir(i)[1]>=0 && y+dir(i)[1]<=4) && (x+dir(i)[0]>=0 && x+dir(i)[0]<=4))){
				pop=true;
			} else {
				pop=false;
				
			}
			try
			{if(!(maze[y+dir(i)[1]][x+dir(i)[0]]=='0,0,0,0')){
				pop=true;
			} else {
				pop=false;
				break;
			}
			}catch(err){}
		}
		//alert(pop);
		try{
		if (pop == true){
			//alert(closed);
			x=closed[closed.length-1][0];
			y=closed[closed.length-1][1];
			closed.pop();
		}
		} catch(err) {
			fin=true;	
		}
	}
	return {maze : maze, x : x, y : y, closed : closed, fin : fin};
}
function doEdges(maze,x,y,l,s,e){
	if((floor((x+1)/3)!=floor(x/3))||(floor((x-1)/3)!=floor(x/3))||(floor((y+1)/3)!=floor(y/3))||(floor((y-1)/3)!=floor(y/3))){
		var olu=createmaze(floor(x/3),floor(y/3),l+1,s);//one level up
		//alert('here');
	} else {
		var olu=createmaze(floor(x/3),floor(y/3),l+1,s,false);
	}
	for(var i; i>4; i++){
		if(olu[(y-floor(y/3)*5)+2][(x-floor(x/3)*5)+2][i]){
			alert(i);
		}
	}
	return maze;
}
function createmaze(sx,sy,sl,s,e){
	if(typeof(e) === "undefined") {
		e=true;
	}
	var seed = sx+' '+sy+' '+sl+' '+s;
	Math.seedrandom(seed);
	var x=randint(0,4);
	var y=randint(0,4);
	var closed=[]
	var i = 0;
	var maze=
[[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],
[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],
[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],
[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],
[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]];
	//draw(maze);
	//alert(i);
	var interval = setInterval( function(){
	var gen=generate(maze,x,y,closed);
	maze=gen.maze;
	x=gen.x;  
	y=gen.y;
	closed=gen.closed;
	i++
	//draw(maze);
	if (gen.fin){
		//alert(e+' '+sl);
		if(e){
			maze=doEdges(maze,sx,sy,sl,s,e);
		}
		if (sl==0){
			draw(maze,sx*5+7.5,sy*5+7.5);
		} else {
			window.clearInterval(interval);
			return maze;
		}
		window.clearInterval(interval);
	}
	},0);
}
createmaze(2,0,0,'test');
createmaze(0,1,0,'test');
createmaze(1,0,0,'test');
createmaze(1,1,0,'test');
function draw(m,x,y){
	var size=35;
	//var w=size/2;
	var w=1;
	JSON.stringify(m);
	var c=document.getElementById("myCanvas");
	var ctx=c.getContext("2d");
	ctx.clearRect(0, 0, c.width, c.height);
	for (i=0; i<5; i++){
		for (j=0; j<5; j++){
			ctx.lineWidth = w;
			if (m[j][i][0]==0){
				ctx.moveTo(i*size-w/2+x*size,j*size+y*size);
				ctx.lineTo((i+1)*size+w/2+x*size,j*size+y*size);
			}
			ctx.stroke();
			if (m[j][i][1]==0){
				ctx.moveTo((i+1)*size+x*size,j*size-w/2+y*size);
				ctx.lineTo((i+1)*size+x*size,(j+1)*size+w/2+y*size);
			}
			ctx.stroke();
			if (m[j][i][2]==0){
				ctx.moveTo(i*size-w/2+x*size,(j+1)*size+y*size);
				ctx.lineTo((i+1)*size+w/2+x*size,(j+1)*size+y*size);
			}
			ctx.stroke();
			if (m[j][i][3]==0){
				ctx.moveTo(i*size+x*size,j*size-w/2+y*size);
				ctx.lineTo(i*size+x*size,(j+1)*size+w/2+y*size);
			}
			ctx.stroke();
		}
	}
}
	</script>
</html>
